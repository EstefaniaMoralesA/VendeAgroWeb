@model VendeAgroWeb.Models.Portal.NuevaTarjetaViewModel

@{
    ViewBag.Title = "Nueva Tarjeta";
}

<div class="row">
    <div class="col-sm-12">
        <div class="row nueva-tarjeta-titulo col-sm-offset-2 col-sm-8" style="margin-top: 60px;">
            <h2 class="mi-cuenta-titulo" style="text-align: center;">Nueva Tarjeta</h2>
            <div class="row tarjeta" style="margin-left: 0px; margin-right: 0px; margin-top:20px; font-size: 16px;">
                <div class="alert alert-danger error-tarjeta">

                </div>
                <form class="form-horizontal" id="forma-pago">
                    <input class="form-control" id="id-usuario" value="@Model.Id" style="display: none;"/>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <input class="form-control" data-openpay-card="holder_name" id="nombre-tarjeta" placeholder="Nombre en la tarjeta" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-6">
                            <input class="form-control" data-openpay-card="card_number" id="numero" placeholder="N&uacute;mero de la tarjeta" />
                        </div>
                        <div class="col-sm-6">
                            <input class="form-control" data-openpay-card="cvv2" id="codigo" placeholder="C&oacute;digo de seguridad" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-6">
                            <h4>Fecha de vencimiento</h4>
                        </div>
                        <div class="col-sm-2">
                            <input class="form-control" data-openpay-card="expiration_month" id="mes" placeholder="Mes" />
                        </div>
                        <div class="col-sm-2">
                            <input class="form-control" data-openpay-card="expiration_year" id="anio" placeholder="A&ntilde;o" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-sm-6 col-sm-offset-3">
                <div class="row">
                    <a id="btn-nueva-tarjeta" class="btn btn-default botones-grad agregar-tarjeta-boton pagar-boton" style="color:white;">Agregar Tarjeta</a>
                </div>
                <div class="row">
                    <a href="/Portal/Perfil" class="btn btn-default agregar-tarjeta-boton pagar-boton">Cancelar</a>
                </div>
            </div>
        </div>
    </div>
</div>

@Scripts.Render("~/bundles/jquery")

<script type="text/javascript"
        src="https://openpay.s3.amazonaws.com/openpay.v1.min.js"></script>
<script type='text/javascript'
        src="https://openpay.s3.amazonaws.com/openpay-data.v1.min.js"></script>
<script>
    $(document).ready(function () {
        OpenPay.setId('m4tpnfpemahz4tgdvadb');
        OpenPay.setApiKey('pk_69eeee9e23b947a5b5dd565cfd810e3a');
        OpenPay.setSandboxMode(true);
    });

    $("#btn-nueva-tarjeta").click(function () {
        var nombre = $("#nombre-tarjeta").val();
        var numero = $("#numero").val();
        var codigo = $("#codigo").val();
        var mes = $("#mes").val();
        var anio = $("#anio").val();
        var valido = true;
        var cadenaError = "<strong>Error:</strong> </br>";

        if (nombre.length < 5) {
            valido = false;
            cadenaError += "    - Introduzca un nombre v&aacute;lido. </br>";
            $("#nombre-tarjeta").addClass("has-error");
        }
        else {
            $("#nombre-tarjeta").removeClass("has-error");
        }

        if (!(OpenPay.card.validateCardNumber(numero))) {
            valido = false;
            cadenaError += "    - Introduce un n&uacute;mero de tarjeta v&aacute;lido. </br>";
            $("#numero").addClass("has-error");
        }
        else {
            $("#numero").removeClass("has-error");
        }

        if (!(OpenPay.card.validateCVC(codigo, numero))) {
            valido = false;
            cadenaError += "    - Introduce un c&oacute;digo de seguridad v&aacute;lido. </br>";
            $("#codigo").addClass("has-error");
        }
        else {
            $("#codigo").removeClass("has-error");
        }

        if (!(OpenPay.card.validateExpiry(mes, normalizeYear(anio)))) {
            valido = false;
            cadenaError += "    - Introduce una fecha de vencimiento v&aacute;lida. </br>";
            $("#mes").addClass("has-error");
            $("#anio").addClass("has-error");
        }
        else {
            $("#mes").removeClass("has-error");
            $("#anio").removeClass("has-error");
        }

        if (!valido) {
            $(".error-tarjeta").html(cadenaError).show('');
            return;
        }

        $(".error-tarjeta").hide('');
        $(".procesando-pago").show('');
        var deviceSessionId = OpenPay.deviceData.setup("forma-pago", "deviceIdHiddenFieldName");
        console.log("device id: " + deviceSessionId);
        OpenPay.token.extractFormAndCreate('forma-pago', success_callback, error_callback);
    });

    var success_callback = function (token) {
        var sessionId = $("#deviceIdHiddenFieldName").val();
        $(".procesando-pago").hide('');
        var idUsuario = $('#id-usuario').val();

        $.ajax({
            type: 'POST',
            data: { id: idUsuario, tokenTarjeta: token.data.id, sessionId: sessionId},
            url: '/Portal/AgregarTarjeta',
            success: function (response) {
                alert(response);
                if (response) {
                    location.reload();
                    return;
                }
                else {
                    $(".error-row").html("Hubo un error al modificar el nombre. Porfavor vuelva a intentarlo.").show('');
                    return;
                }
            },
            error: function (err) {
                $(".error-row").html("Hubo un error al modificar. Porfavor vuelva a intentarlo.").show('');
                return;
            }
        });
        return token;
    };



    var error_callback = function (response) {
        var desc = response.data.description != undefined ?
        response.data.description : response.message;
        console.log("error: " + desc);
        $(".procesando-pago").hide('');
        $(".error-tarjeta").html(desc).show('');
        return;
    };

    function normalizeYear(anio)
    {
        if (anio.length === 4) return anio;

        if (anio.length != 2) return anio;

        var d = new Date();
        var n = d.getFullYear().toString();
        var dig = n.substr(0, 2);
        console.log(dig);
        return dig + anio;
    }
</script>